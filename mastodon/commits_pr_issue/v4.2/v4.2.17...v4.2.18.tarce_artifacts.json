{
  "repo": "mastodon/mastodon",
  "base": "v4.2.17",
  "compare": "v4.2.18",
  "counts": {
    "commits": 7,
    "prs": 7,
    "issues": 2,
    "commit_pr": 7,
    "commit_pr_issue": 2
  },
  "source_files": {
    "pairs": "pairs/v4.2/v4.2.17...v4.2.18.compare.json",
    "commits": "commits/v4.2/v4.2.17...v4.2.18.commits.json",
    "pulls": "pulls/v4.2/v4.2.17...v4.2.18.pulls.json",
    "issues": "issues/v4.2/v4.2.17...v4.2.18.issues.json"
  },
  "commit_pr_issue": [
    {
      "commit": [
        {
          "sha": "9a41c655827fe2df61bfec1c72cef2b920ad4f6a",
          "html_url": "https://github.com/mastodon/mastodon/commit/9a41c655827fe2df61bfec1c72cef2b920ad4f6a",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/commits/9a41c655827fe2df61bfec1c72cef2b920ad4f6a",
          "author_login": "ClearlyClaire",
          "commit_author_date": "2025-02-28T07:46:57Z",
          "commit_title": "Add Ruby 3.3 to Mastodon 4.2 test matrix"
        }
      ],
      "prs": [
        {
          "number": 34029,
          "html_url": "https://github.com/mastodon/mastodon/pull/34029",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/34029",
          "state": "closed",
          "merged_at": "2025-02-28T09:16:25Z",
          "pr_title": "Add Ruby 3.3 support to Mastodon 4.2",
          "pr_body": null,
          "labels": [],
          "issue_refs": []
        }
      ],
      "issues": []
    },
    {
      "commit": [
        {
          "sha": "b0ef64243d1c2993941ba535994579bf7f0e37d9",
          "html_url": "https://github.com/mastodon/mastodon/commit/b0ef64243d1c2993941ba535994579bf7f0e37d9",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/commits/b0ef64243d1c2993941ba535994579bf7f0e37d9",
          "author_login": "mjankowski",
          "commit_author_date": "2024-01-04T16:55:00Z",
          "commit_title": "Add sleep statement to nudge thread scheduler in request pool spec (#28596)"
        }
      ],
      "prs": [
        {
          "number": 34029,
          "html_url": "https://github.com/mastodon/mastodon/pull/34029",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/34029",
          "state": "closed",
          "merged_at": "2025-02-28T09:16:25Z",
          "pr_title": "Add Ruby 3.3 support to Mastodon 4.2",
          "pr_body": null,
          "labels": [],
          "issue_refs": []
        },
        {
          "number": 28596,
          "html_url": "https://github.com/mastodon/mastodon/pull/28596",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/28596",
          "state": "closed",
          "merged_at": "2024-01-04T17:00:32Z",
          "pr_title": "Add sleep statement to nudge thread scheduler in request pool spec",
          "pr_body": "Based on some discussion here - https://github.com/mastodon/mastodon/pull/28013#issuecomment-1876832460 - this is an attempt to get ruby 3.3.0 thread scheduler to exercise this spec as prior versions were doing. The insight on that discussion was that since we're stubbing out the request, the thread scheduler may not be switching between threads as often as in prior rubies, and so we are not getting the collection of connections we expect.\r\n\r\nThe proposal there was to add some short sleep statements within the inner loop of the spec so that the scheduler would move to another thread -- this works, but it increases the time of running just this one example to ~2.5s. I had another idea, included in this PR, to just add a debugging line, which a) might actually be useful to see execution, b) might function similarly to the `sleep` calls in nudging the scheduler, while not slowing down the spec as much.\r\n\r\nI believe this change preserves the original intent of the spec, and that actually doing something with the result of the http call (logging in this case) is probably a truer reflection of actual usage than just stubbing the response and doing nothing with it.\r\n\r\nSeparately -- we could contemplate stubbing out the constants which dictate the pool size here, and reducing the number of both inner/outer loops here to be just enough to exercise the pooling, but not more than needed. Let me know if that's desired as well.\r\n\r\nAssuming we like this or a similar approach, I can rebase the 3.3 PR after this is in.",
          "labels": [],
          "issue_refs": []
        }
      ],
      "issues": []
    },
    {
      "commit": [
        {
          "sha": "bd78330a2415020da9ee92e4137d73b999de1809",
          "html_url": "https://github.com/mastodon/mastodon/commit/bd78330a2415020da9ee92e4137d73b999de1809",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/commits/bd78330a2415020da9ee92e4137d73b999de1809",
          "author_login": "ClearlyClaire",
          "commit_author_date": "2024-01-08T12:29:05Z",
          "commit_title": "Make request_pool_spec tests more robust (#28610)"
        }
      ],
      "prs": [
        {
          "number": 34029,
          "html_url": "https://github.com/mastodon/mastodon/pull/34029",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/34029",
          "state": "closed",
          "merged_at": "2025-02-28T09:16:25Z",
          "pr_title": "Add Ruby 3.3 support to Mastodon 4.2",
          "pr_body": null,
          "labels": [],
          "issue_refs": []
        },
        {
          "number": 28610,
          "html_url": "https://github.com/mastodon/mastodon/pull/28610",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/28610",
          "state": "closed",
          "merged_at": "2024-01-08T12:34:35Z",
          "pr_title": "Make request_pool_spec tests more robust",
          "pr_body": "See https://github.com/mastodon/mastodon/pull/28596#issuecomment-1878645034",
          "labels": [],
          "issue_refs": []
        }
      ],
      "issues": []
    },
    {
      "commit": [
        {
          "sha": "962587bfc8d16ff4b10261db9cba6fb309eb78f9",
          "html_url": "https://github.com/mastodon/mastodon/commit/962587bfc8d16ff4b10261db9cba6fb309eb78f9",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/commits/962587bfc8d16ff4b10261db9cba6fb309eb78f9",
          "author_login": "ClearlyClaire",
          "commit_author_date": "2025-03-07T09:20:44Z",
          "commit_title": "Fix streaming server not filtering unknown-language posts from public timelines (#33774)"
        }
      ],
      "prs": [
        {
          "number": 34103,
          "html_url": "https://github.com/mastodon/mastodon/pull/34103",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/34103",
          "state": "closed",
          "merged_at": "2025-03-10T09:14:30Z",
          "pr_title": "Bump version to v4.2.18",
          "pr_body": "### Changed\r\n\r\n- Change hashtag suggestion to prefer personal history capitalization (#34070 by `@ClearlyClaire`)\r\n\r\n### Fixed\r\n\r\n- Fix processing errors for some HEIF images from iOS 18 (#34086 by `@renchap`)\r\n- Fix streaming server not filtering unknown-language posts from public timelines (#33774 by `@ClearlyClaire`)",
          "labels": [
            "backport",
            "build-image"
          ],
          "issue_refs": []
        },
        {
          "number": 33774,
          "html_url": "https://github.com/mastodon/mastodon/pull/33774",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/33774",
          "state": "closed",
          "merged_at": "2025-02-21T07:56:39Z",
          "pr_title": "Fix streaming server not filtering unknown-language posts from public timelines",
          "pr_body": "Fixes #33742\r\n\r\nI am not 100% sure whether we want the streaming server to adopt the REST API behavior (this PR), or the REST API behavior to change to adopt the streaming server's behavior, but I have a preference for the former, hence the PR.",
          "labels": [
            "javascript",
            "streaming"
          ],
          "issue_refs": [
            {
              "number": 33742,
              "html_url": "https://github.com/mastodon/mastodon/issues/33742",
              "relationship": "closes"
            }
          ]
        }
      ],
      "issues": [
        {
          "number": 33742,
          "html_url": "https://github.com/mastodon/mastodon/issues/33742",
          "state": "closed",
          "issue_title": "Streaming API and REST API language filtering is inconsistent",
          "issue_body": "### Steps to reproduce the problem\n\n1. select chosen languages in `/settings/preferences/other`\n2. open the public timeline\n3. observe new posts appearing\n4. refresh page\n\n### Expected behaviour\n\nrefreshing the page should result in the same posts\n\n### Actual behaviour\n\nstreaming gets more posts than REST API\n\n### Detailed description\n\nAt first glance, this seems to be due to the language filtering logic being different in the streaming server (`streamFrom` function) and the Ruby server (`PublicFeed#language_scope`):\n- the streaming code treats posts with an unknown language as acceptable (`payload.language !== null `)\n- when language filtering is enabled, the Ruby code does not return posts with `language: nil`\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0\n\n### Technical details\n\n_No response_",
          "labels": [
            "status/to triage"
          ]
        }
      ]
    },
    {
      "commit": [
        {
          "sha": "bba17bc46720341a3b2215a4537b60393f03e667",
          "html_url": "https://github.com/mastodon/mastodon/commit/bba17bc46720341a3b2215a4537b60393f03e667",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/commits/bba17bc46720341a3b2215a4537b60393f03e667",
          "author_login": "ClearlyClaire",
          "commit_author_date": "2025-03-07T09:32:07Z",
          "commit_title": "Fix processing errors for some HEIF images from iOS 18 (#34086)"
        }
      ],
      "prs": [
        {
          "number": 34103,
          "html_url": "https://github.com/mastodon/mastodon/pull/34103",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/34103",
          "state": "closed",
          "merged_at": "2025-03-10T09:14:30Z",
          "pr_title": "Bump version to v4.2.18",
          "pr_body": "### Changed\r\n\r\n- Change hashtag suggestion to prefer personal history capitalization (#34070 by `@ClearlyClaire`)\r\n\r\n### Fixed\r\n\r\n- Fix processing errors for some HEIF images from iOS 18 (#34086 by `@renchap`)\r\n- Fix streaming server not filtering unknown-language posts from public timelines (#33774 by `@ClearlyClaire`)",
          "labels": [
            "backport",
            "build-image"
          ],
          "issue_refs": []
        },
        {
          "number": 34086,
          "html_url": "https://github.com/mastodon/mastodon/pull/34086",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/34086",
          "state": "closed",
          "merged_at": "2025-03-06T10:52:45Z",
          "pr_title": "Fix processing errors for some HEIF images from iOS 18",
          "pr_body": "Old versions of `libheif` have a bug with those images (related to HDR metadata). The easiest solution for us is to use `libheif` from Debian backports, which is a recent version (1.19, vs 1.15 in mainline).\r\n\r\nThe issue should happen wether `imagemagick` or `vips` is used, as this is a bug in the underlying library.\r\n\r\nSee https://github.com/libvips/libvips/issues/4169\r\n\r\nFixes #31570",
          "labels": [],
          "issue_refs": [
            {
              "number": 31570,
              "html_url": "https://github.com/mastodon/mastodon/issues/31570",
              "relationship": "closes"
            }
          ]
        }
      ],
      "issues": [
        {
          "number": 31570,
          "html_url": "https://github.com/mastodon/mastodon/issues/31570",
          "state": "closed",
          "issue_title": "errors uploading iPhone HEIC images",
          "issue_body": "### Steps to reproduce the problem\r\n\r\n1. Attempt to upload an HEIC photo taken on an iPhone\r\n2. See \"500 Error processing thumbnail for uploaded media\" in the web UI\r\n\r\n### Expected behaviour\r\n\r\nThe image should upload and post\r\n\r\n### Actual behaviour\r\n\r\nThe image fails to upload\r\n\r\n### Detailed description\r\n\r\nI initially thought this might be from using libvips but upon further testing, it occurs whether or not I have `MASTODON_USE_LIBVIPS=true` in .env.production, so it seems to be something else.\r\n\r\nI have attached two sample images that reproduce the issue (as a zip; GitHub doesn't support HEIF): [HEIF-images.zip](https://github.com/user-attachments/files/16734152/HEIF-images.zip)\r\n\r\nI also see this in my /var/log/syslog when the issue occurs\r\n\r\n```\r\n2024-08-23T12:32:35.879625-07:00 koi bundle[47993]: E, [2024-08-23T12:32:35.878990 #47993] ERROR -- : [2295fbc3-5619-4ccf-a574-e19fc5116ece] Paperclip::Error: Error while optimizing 799cd6bfc52d5baa8ba87191e42bdc0820240823-47993-10b16y: /tmp/799cd6bfc52d5baa8ba87191e42bdc0820240823-47993-10b16y.heif: bad seek to 3413051\r\n2024-08-23T12:32:35.880347-07:00 koi bundle[47993]: heif: Invalid input: Unspecified: Metadata not correctly assigned to image (2.0)\r\n```\r\n\r\n### Mastodon instance\r\n\r\npuddle.town\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-beta.1\r\n\r\n### Technical details\r\n\r\n```\r\n$ ruby --version\r\nruby 3.3.4 (2024-07-09 revision be1089c8ec) [x86_64-linux]\r\n```\r\n\r\n```\r\n$ node --version\r\nv20.17.0\r\n```\r\n\r\n```\r\n$ cat /etc/lsb-release \r\nDISTRIB_ID=Ubuntu\r\nDISTRIB_RELEASE=24.04\r\nDISTRIB_CODENAME=noble\r\nDISTRIB_DESCRIPTION=\"Ubuntu 24.04 LTS\"\r\n```\r\n\r\n```\r\n$ vips -v             \r\nvips-8.15.1\r\n```\r\n\r\n```\r\n$ vips --vips-config\r\nenable debug: false\r\nenable deprecated: true\r\nenable modules: true\r\nenable cplusplus: true\r\nenable RAD load/save: true\r\nenable Analyze7 load/save: true\r\nenable PPM load/save: true\r\nenable GIF load: true\r\nuse fftw for FFTs: true\r\nSIMD support with highway: true\r\naccelerate loops with ORC: false\r\nICC profile support with lcms: true\r\nzlib: true\r\ntext rendering with pangocairo: true\r\nfont file support with fontconfig: true\r\nEXIF metadata support with libexif: true\r\nJPEG load/save with libjpeg: true\r\nJXL load/save with libjxl: true (dynamic module: true)\r\nJPEG2000 load/save with OpenJPEG: true\r\nPNG load/save with libspng: true\r\nPNG load/save with libpng: false\r\nselected quantisation package: imagequant\r\nTIFF load/save with libtiff: true\r\nimage pyramid save with libarchive: true\r\nHEIC/AVIF load/save with libheif: true (dynamic module: true)\r\nWebP load/save with libwebp: true\r\nPDF load with PDFium: false\r\nPDF load with poppler-glib: true (dynamic module: true)\r\nSVG load with librsvg: true\r\nEXR load with OpenEXR: true\r\nOpenSlide load: true (dynamic module: true)\r\nMatlab load with libmatio: true\r\nNIfTI load/save with niftiio: false\r\nFITS load/save with cfitsio: true\r\nGIF save with cgif: true\r\nselected Magick package: MagickCore (dynamic module: true)\r\nMagick API version: magick6\r\nMagick load: true\r\nMagick save: true\r\n```",
          "labels": [
            "status/identified",
            "area/media processing"
          ]
        }
      ]
    },
    {
      "commit": [
        {
          "sha": "a9756884abe018ffa9dd404715ea400570b34034",
          "html_url": "https://github.com/mastodon/mastodon/commit/a9756884abe018ffa9dd404715ea400570b34034",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/commits/a9756884abe018ffa9dd404715ea400570b34034",
          "author_login": "ClearlyClaire",
          "commit_author_date": "2025-03-06T10:00:33Z",
          "commit_title": "Change hashtag suggestion to prefer personal history capitalization (#34070)"
        }
      ],
      "prs": [
        {
          "number": 34103,
          "html_url": "https://github.com/mastodon/mastodon/pull/34103",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/34103",
          "state": "closed",
          "merged_at": "2025-03-10T09:14:30Z",
          "pr_title": "Bump version to v4.2.18",
          "pr_body": "### Changed\r\n\r\n- Change hashtag suggestion to prefer personal history capitalization (#34070 by `@ClearlyClaire`)\r\n\r\n### Fixed\r\n\r\n- Fix processing errors for some HEIF images from iOS 18 (#34086 by `@renchap`)\r\n- Fix streaming server not filtering unknown-language posts from public timelines (#33774 by `@ClearlyClaire`)",
          "labels": [
            "backport",
            "build-image"
          ],
          "issue_refs": []
        },
        {
          "number": 34070,
          "html_url": "https://github.com/mastodon/mastodon/pull/34070",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/34070",
          "state": "closed",
          "merged_at": "2025-03-06T10:10:06Z",
          "pr_title": "Change hashtag suggestion to prefer personal history capitalization",
          "pr_body": "Currently, personal hashtag use history is used to complete search suggestions, but for suggestions that are part of the server response (which should be most of them), the capitalization used by the server is used instead (e.g. if the user has already used `#ClimateCrisis` in the past, types `#Clim` in the Web UI and the server returns a suggestion for `#climatecrisis`, the UI will present `#climatecrisis` as a suggestion).\r\n\r\nThis PR changes it so that the capitalization of hashtag suggestions is changed to use the one from the local history, unless that one is lowercase-only (e.g. if the client had previously used `#ClimateCrisis` and the server is suggesting `#climatecrisis`, the UI will suggest `#ClimateCrisis`; if the user had previously typed `#climatecrisis` and the server is suggesting `#ClimateCrisis`, the UI will suggest `#ClimateCrisis` as well).",
          "labels": [
            "area/web interface"
          ],
          "issue_refs": []
        }
      ],
      "issues": []
    },
    {
      "commit": [
        {
          "sha": "443871d913a3c2d459cc6ab779c6f3466de10007",
          "html_url": "https://github.com/mastodon/mastodon/commit/443871d913a3c2d459cc6ab779c6f3466de10007",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/commits/443871d913a3c2d459cc6ab779c6f3466de10007",
          "author_login": "ClearlyClaire",
          "commit_author_date": "2025-03-07T09:34:24Z",
          "commit_title": "Bump version to v4.2.18"
        }
      ],
      "prs": [
        {
          "number": 34103,
          "html_url": "https://github.com/mastodon/mastodon/pull/34103",
          "api_url": "https://api.github.com/repos/mastodon/mastodon/pulls/34103",
          "state": "closed",
          "merged_at": "2025-03-10T09:14:30Z",
          "pr_title": "Bump version to v4.2.18",
          "pr_body": "### Changed\r\n\r\n- Change hashtag suggestion to prefer personal history capitalization (#34070 by `@ClearlyClaire`)\r\n\r\n### Fixed\r\n\r\n- Fix processing errors for some HEIF images from iOS 18 (#34086 by `@renchap`)\r\n- Fix streaming server not filtering unknown-language posts from public timelines (#33774 by `@ClearlyClaire`)",
          "labels": [
            "backport",
            "build-image"
          ],
          "issue_refs": []
        }
      ],
      "issues": []
    }
  ]
}